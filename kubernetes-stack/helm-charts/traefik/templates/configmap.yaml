apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "traefik.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "traefik.labels" . | nindent 4 }}
data:
  traefik.yml: |
    {{- toYaml .Values.config | nindent 4 }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "traefik.fullname" . }}-middlewares
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "traefik.labels" . | nindent 4 }}
data:
  middleware.yaml: |
    http:
      middlewares:
        {{- if .Values.middlewares.httpsRedirect.enabled }}
        https-redirect:
          redirectScheme:
            scheme: https
            permanent: true
            port: "443"
        {{- else }}
        # Placeholder middleware for local development
        no-redirect:
          headers:
            customRequestHeaders:
              X-Development: "true"
        {{- end }}
        
        {{- if .Values.middlewares.basicAuth.enabled }}
        basic-auth:
          basicAuth:
            users:
              {{- range .Values.canopy.basicAuth.users }}
              - {{ . | quote }}
              {{- end }}
        {{- else }}
        # Placeholder basic auth for local development
        no-auth:
          headers:
            customRequestHeaders:
              X-Auth-Disabled: "true"
        {{- end }}
        
        {{- if .Values.middlewares.websocketHeaders.enabled }}
        websocket-headers:
          headers:
            customRequestHeaders:
              X-Forwarded-Proto: "http"
              X-Forwarded-Port: "80"
            customResponseHeaders:
              X-Frame-Options: "SAMEORIGIN"
              X-Content-Type-Options: "nosniff"
        {{- end }} 